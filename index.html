<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Drift NC - Lagoon King</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700;900&family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAv5_57JNF_-ZK7lRAOnqnD_C6zbXzHxSE",
      authDomain: "micromachines-8e585.firebaseapp.com",
      projectId: "micromachines-8e585",
      storageBucket: "micromachines-8e585.firebasestorage.app",
      messagingSenderId: "148484924404",
      appId: "1:148484924404:web:7fe9d8c4abac880a574fa1",
      measurementId: "G-78WHHQGK2S"
    };

    try {
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        window.CloudTools = { db, collection, addDoc, query, orderBy, limit, onSnapshot };
        signInAnonymously(auth).catch((e) => console.warn("Auth offline"));
    } catch(e) { 
        console.warn("Firebase erreur, passage en local.");
        window.CloudTools = null;
    }
  </script>

  <style>
    :root{ --bg0:#0891b2; --bg1:#0c4a6e; --glass: rgba(255,255,255,0.15); --stroke: rgba(255,255,255,0.3); --gold:#fbbf24; --red:#ef4444; --purple:#d946ef; --green:#22c55e; }
    *{ box-sizing: border-box; }
    body { margin:0; overflow:hidden; background: radial-gradient(circle at center, #22d3ee 0%, #0284c7 60%, #0c4a6e 100%); color:white; font-family: Inter, sans-serif; touch-action:none; user-select:none; }
    canvas{ display:block; }

    /* UI Z-INDEX FIXES */
    #welcome-screen, #race-sub-screen, #difficulty-screen, #car-select-screen { 
        position:fixed; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; 
        z-index: 80; /* Menus au dessus du jeu */
        background: linear-gradient(135deg, rgba(6,182,212,0.95), rgba(12,74,110,0.95)); backdrop-filter: blur(15px); 
        overflow-y: auto; padding: 15px;
    }
    #race-sub-screen, #difficulty-screen, #car-select-screen { display: none; background: rgba(15, 23, 42, 0.98); }

    #leaderboard-panel { 
        position:absolute; top:50%; left:50%; transform: translate(-50%,-50%); 
        width: 92%; max-width: 480px; 
        z-index: 90; /* Au dessus de tout quand affich√© */
        display:none; 
        background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(255,255,255,0.2); border-radius: 18px; box-shadow: 0 20px 60px rgba(0,0,0,0.8); backdrop-filter: blur(20px); padding: 18px; text-align:center; 
    }

    #hud-layer{ position:absolute; top:0; left:0; width:100%; padding: 10px; pointer-events:none; z-index:10; display:flex; justify-content:space-between; gap:6px; }
    .hud-card{ pointer-events:none; background: linear-gradient(180deg, rgba(255,255,255,0.25), rgba(255,255,255,0.1)); border: 1px solid var(--stroke); border-radius: 12px; padding: 8px 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); backdrop-filter: blur(8px); min-width: 80px; flex-shrink: 1; }
    .hud-top{ display:flex; align-items:center; gap:6px; opacity:0.95; }
    .label{ font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.1em; opacity: 0.85; text-shadow: 0 1px 2px rgba(0,0,0,0.2); }
    .sub-info{ font-family: Orbitron, monospace; font-size: 1rem; margin-top: 2px; text-shadow: 0 2px 4px rgba(0,0,0,0.3); }
    .big-time{ font-family: Orbitron, monospace; font-weight: 900; font-size: clamp(1.2rem, 5vw, 2.0rem); color: #fff; text-shadow: 0 2px 10px rgba(0,0,0,0.3); white-space: nowrap; }
    
    #drift-ui { position: absolute; top: 90px; left: 50%; transform: translateX(-50%); text-align: center; pointer-events: none; z-index: 15; display: none; }
    .combo-box { background: rgba(0,0,0,0.6); border: 2px solid #d946ef; border-radius: 12px; padding: 5px 15px; transform: skewX(-10deg); box-shadow: 0 0 15px #d946ef; }
    .combo-text { font-family: Orbitron; font-weight: 900; font-size: 1.5rem; color: #fff; text-shadow: 0 0 10px #d946ef; }
    .combo-mult { font-size: 1rem; color: #f0abfc; margin-left: 5px; }
    .drift-score-inc { font-family: Orbitron; font-size: 1.2rem; color: #fbbf24; margin-top: 5px; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
    
    #wrong-way-alert { display: none; color: #ef4444; font-family: Orbitron; font-weight: 900; font-size: 1.5rem; text-transform: uppercase; margin-top: 5px; animation: blinkFast 0.2s infinite alternate; text-shadow: 0 0 20px red; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 5px; }
    @keyframes blinkFast { from { opacity: 1; transform: scale(1); } to { opacity: 0.5; transform: scale(1.1); } }

    #dq-screen { position:absolute; inset:0; z-index: 95; background: rgba(127, 29, 29, 0.9); backdrop-filter: blur(10px); display: none; flex-direction: column; align-items: center; justify-content: center; text-align: center; }
    .dq-title { font-family: Orbitron; font-weight: 900; font-size: 3rem; color: white; text-shadow: 0 5px 0 #000; margin-bottom: 10px; }
    .dq-sub { font-family: Inter; font-weight: 800; font-size: 1.2rem; color: #fca5a5; margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; }

    .badge{ display:inline-flex; align-items:center; gap:8px; padding: 6px 12px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.4); background: rgba(255,255,255,0.15); backdrop-filter: blur(10px); font-size: 12px; font-weight: 600; margin-bottom: 10px; flex-shrink: 0; }
    .badge-dot{ width: 8px; height: 8px; border-radius: 50%; background: #67e8f9; box-shadow: 0 0 10px #67e8f9; }
    .poster-wrap{ margin-bottom: 20px; padding: 10px; border-radius: 18px; border: 1px solid rgba(255,255,255,0.3); background: rgba(255,255,255,0.15); box-shadow: 0 20px 50px rgba(0,0,0,0.3); transform: rotate(-1.5deg); transition: transform 400ms ease; display: inline-block; width: auto; max-width: 90vw; }
    .poster-wrap:hover{ transform: rotate(0deg) scale(1.01); }
    #poster-img{ display: block; width: 100%; height: auto; max-height: 45vh; border-radius: 10px; object-fit: contain; }

    .mode-container { display: flex; gap: 10px; flex-wrap: wrap; justify-content: center; width: 100%; max-width: 600px; }
    .mode-btn { flex: 1; min-width: 120px; padding: 20px 10px; border-radius: 12px; font-weight: 800; font-size: 1rem; text-transform: uppercase; border: 2px solid rgba(255,255,255,0.2); color: #fff; cursor: pointer; transition: transform 0.2s, filter 0.2s; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
    .mode-btn:hover { transform: scale(1.05); filter: brightness(1.2); }
    .mode-btn:active { transform: scale(0.95); }
    .btn-main-race { background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%); border-color: #38bdf8; }
    .btn-main-drift { background: linear-gradient(135deg, #d946ef 0%, #a21caf 100%); border-color: #f0abfc; }
    .btn-normal { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); border-color: #fca5a5; }
    .btn-expert { background: linear-gradient(135deg, #1f2937 0%, #000000 100%); border-color: #9ca3af; }
    .btn-practice { background: linear-gradient(135deg, #10b981 0%, #047857 100%); border-color: #6ee7b7; }
    .btn-locked { background: #334155; border-color: #475569; color: #94a3b8; cursor: not-allowed; filter: grayscale(1); }
    .back-btn { margin-top: 30px; background: transparent; border: none; color: #94a3b8; font-weight: 700; text-transform: uppercase; letter-spacing: 0.1em; cursor: pointer; }
    .back-btn:hover { color: white; }

    .car-card { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 16px; padding: 20px; text-align: center; width: 100%; max-width: 280px; cursor: pointer; transition: 0.2s; position: relative; overflow: hidden; }
    .car-card:hover { background: rgba(255,255,255,0.2); transform: translateY(-5px); border-color: white; }
    .car-card h3 { font-family: Orbitron; font-size: 1.5rem; margin: 0 0 5px 0; }
    .car-card p { font-size: 0.85rem; opacity: 0.8; margin: 0; }
    .car-card .stats { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
    .stat-bar { height: 6px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; }
    .stat-fill { height: 100%; background: white; width: 0%; }
    .card-street { border-color: #4ade80; } .card-street:hover { box-shadow: 0 0 20px rgba(74, 222, 128, 0.4); } .card-street h3 { color: #4ade80; } .card-street .stat-fill { background: #4ade80; }
    .card-pro { border-color: #d946ef; } .card-pro:hover { box-shadow: 0 0 20px rgba(217, 70, 239, 0.4); } .card-pro h3 { color: #d946ef; } .card-pro .stat-fill { background: #d946ef; }

    .score-row{ display:flex; justify-content:space-between; padding: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); font-family: Orbitron, monospace; font-size: 0.95rem; }
    #scores-list{ margin-top: 10px; text-align:left; background: rgba(0,0,0,0.3); border-radius: 14px; padding: 8px; max-height: 220px; overflow-y:auto; }
    input{ background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; padding: 12px; border-radius: 12px; width: 100%; text-align:center; font-size: 1.05rem; outline:none; }
    .action-btn{ width: 100%; margin-top: 12px; padding: 12px 16px; border-radius: 14px; border: 1px solid rgba(255,255,255,0.18); font-weight: 900; letter-spacing: 0.04em; text-transform: uppercase; background: linear-gradient(90deg, rgba(72,187,120,1), rgba(34,197,94,0.85)); box-shadow: 0 18px 45px rgba(0,0,0,0.35); transition: transform 150ms ease, filter 200ms ease; cursor:pointer; }
    .action-btn:hover{ transform: translateY(-1px); filter: brightness(1.05); }

    #pause-btn{ position:absolute; top:75px; right:16px; width:44px; height:44px; border-radius:999px; display:none; align-items:center; justify-content:center; pointer-events:auto; z-index:50; cursor:pointer; background:rgba(255,255,255,0.2); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(5px); }
    .pause-icon{ width:16px; height:16px; position:relative; }
    .pause-icon::before, .pause-icon::after{ content:""; position:absolute; top:0; bottom:0; width:5px; border-radius:3px; background:white; }
    .pause-icon::before{ left:0; } .pause-icon::after{ right:0; }
    #pause-menu{ position:absolute; inset:0; display:none; flex-direction:column; align-items:center; justify-content:center; z-index:80; background:rgba(15,23,42,0.8); backdrop-filter:blur(15px); pointer-events:auto; }
    .menu-btn{ background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.3); padding:12px 30px; color:white; font-weight:900; border-radius:999px; cursor:pointer; margin:10px; width:220px; text-transform:uppercase; transition:0.2s; pointer-events:auto; }
    .menu-btn:hover{ background:white; color:#0f172a; }
    .menu-btn.red{ border-color:#ef4444; color:#ef4444; background:rgba(239,68,68,0.1); }
    .menu-btn.red:hover{ background:#ef4444; color:white; }

    #mobile-controls{ position:absolute; left:0; right:0; bottom:calc(18px + env(safe-area-inset-bottom)); height:150px; display:flex; justify-content:space-between; padding:0 18px; pointer-events:none; z-index:20; }
    .control-group{ display:flex; gap:14px; align-items:flex-end; pointer-events:auto; }
    .btn{ width:78px; height:78px; border-radius:999px; display:flex; align-items:center; justify-content:center; font-weight:900; color:white; background:rgba(255,255,255,0.15); border:1px solid rgba(255,255,255,0.3); backdrop-filter:blur(10px); touch-action:none; user-select:none; }
    .btn:active, .btn.active{ transform:scale(0.95); background:rgba(255,255,255,0.3); }
    .btn.gas{ background:rgba(34,197,94,0.3); border-color:rgba(34,197,94,0.5); }
    .btn.brake{ background:rgba(239,68,68,0.3); border-color:rgba(239,68,68,0.5); }
    
    #countdown-layer{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:90; pointer-events:none; font-family: Orbitron, sans-serif; font-weight:900; text-align: center; color:white; text-shadow:0 0 40px rgba(0,0,0,0.8); }
    .rolling-text { font-size: 2.5rem; color: #fbbf24; animation: blink 0.5s infinite alternate; }
    @keyframes blink { from { opacity: 1; } to { opacity: 0.5; } }
    .go-text { font-size: 8rem; color: #34d399; animation: countPop 0.8s cubic-bezier(0.1, 0.7, 1.0, 0.1) forwards; }
    @keyframes countPop{ 0%{ transform:scale(0.5); opacity:0; } 30%{ transform:scale(1.2); opacity:1; } 100%{ transform:scale(1); opacity:0; } }
  </style>
</head>

<body>
  <div id="hud-layer">
    <div class="hud-card" style="text-align:left;">
      <div class="hud-top"><div class="label">Tour</div></div>
      <div id="lap-display" class="sub-info">1 / 3</div>
    </div>
    <div class="hud-card" style="text-align:center; min-width: 110px; flex: 1; max-width: 250px;">
      <div class="hud-top" style="justify-content:center;"><div class="label" id="main-stat-label">Chrono</div></div>
      <div id="main-stat-display" class="big-time">00:00.000</div>
    </div>
    <div class="hud-card" style="text-align:right;">
      <div class="hud-top" style="justify-content:flex-end;"><div class="label">Record</div></div>
      <div id="wr-display" class="sub-info" style="color:#fbbf24;">--:--.---</div>
    </div>
  </div>

  <div id="drift-ui">
      <div class="combo-box">
          <span class="combo-text">DRIFT</span>
          <span id="drift-multiplier" class="combo-mult">x1</span>
      </div>
      <div id="drift-current-points" class="drift-score-inc">+0</div>
      <div id="wrong-way-alert">‚ö†Ô∏è SENS INTERDIT ‚ö†Ô∏è</div>
  </div>

  <div id="pause-btn"><div class="pause-icon"></div></div>

  <div id="pause-menu">
    <div class="hud-card" style="min-width: 320px; text-align:center; pointer-events:auto; background:transparent; border:none; box-shadow:none;">
      <h2 class="text-4xl font-black mb-6 text-white" style="font-family:Orbitron;">PAUSE</h2>
      <button id="resume-btn" class="menu-btn">Reprendre</button>
      <button id="restart-btn" class="menu-btn">Recommencer</button>
      <button id="quit-btn" class="menu-btn red">Quitter</button>
    </div>
  </div>

  <div id="dq-screen">
      <div class="dq-title">DISQUALIFI√â</div>
      <div class="dq-sub">SENS INTERDIT D√âTECT√â</div>
      <button class="action-btn" onclick="RaceManager.quitToMenu()" style="width:200px;">MENU</button>
      <button class="action-btn" onclick="RaceManager.startRollingStart()" style="width:200px; margin-top:10px;">R√âESSAYER</button>
  </div>

  <div id="welcome-screen">
    <div class="badge">
      <span class="badge-dot"></span>
      <span>Lagoon Edition ‚Ä¢ Nouvelle-Cal√©donie</span>
    </div>
    <div class="poster-wrap">
      <img id="poster-img" src="https://i.postimg.cc/vB21QZmP/image-drift-nc.png" alt="Drift NC Poster">
    </div>
    <div class="mb-2 text-sm text-gray-200 font-bold tracking-widest uppercase">MODE DE JEU</div>
    <div class="mode-container">
        <button class="mode-btn btn-main-race" onclick="RaceManager.goToRaceSubMenu()">
            <div style="font-size:1.5rem; margin-bottom:5px;">üèéÔ∏è</div>
            COURSE
        </button>
        <button class="mode-btn btn-main-drift" onclick="RaceManager.goToDriftMenu()">
            <div style="font-size:1.5rem; margin-bottom:5px;">üí®</div>
            DRIFT
        </button>
    </div>
  </div>

  <div id="race-sub-screen">
      <h2 class="text-3xl font-black text-white mb-6" style="font-family:Orbitron;">MODE COURSE</h2>
      <div class="mode-container" style="flex-direction:column; gap:15px;">
          <button class="mode-btn btn-normal" onclick="RaceManager.selectCategory('time_trial')" style="width:100%; max-width:320px;">
              ‚è±Ô∏è CONTRE-LA-MONTRE
              <div style="font-size:0.7em; opacity:0.8; font-weight:400; margin-top:4px;">3 Tours ‚Ä¢ Leaderboard</div>
          </button>
          <button class="mode-btn btn-practice" onclick="RaceManager.selectCategory('practice')" style="width:100%; max-width:320px;">
              üîÑ ENTRA√éNEMENT
              <div style="font-size:0.7em; opacity:0.8; font-weight:400; margin-top:4px;">Infini ‚Ä¢ Fant√¥me Session</div>
          </button>
          <button class="mode-btn btn-locked" style="width:100%; max-width:320px;" disabled>
              üîí COURSE (IA)
              <div style="font-size:0.7em; opacity:0.8; font-weight:400; margin-top:4px;">Prochainement</div>
          </button>
      </div>
      <button class="back-btn" onclick="RaceManager.backToMain()">Retour</button>
  </div>

  <div id="difficulty-screen">
      <h2 class="text-3xl font-black text-white mb-6" style="font-family:Orbitron;">CLASSE</h2>
      <div class="mode-container">
          <button class="mode-btn btn-normal" onclick="RaceManager.selectDifficulty('normal')">
              NORMAL
              <div style="font-size:0.7em; opacity:0.8; margin-top:4px;">√âquilibr√©</div>
          </button>
          <button class="mode-btn btn-expert" onclick="RaceManager.selectDifficulty('expert')">
              EXPERT
              <div style="font-size:0.7em; opacity:0.8; margin-top:4px;">Rapide & Technique</div>
          </button>
      </div>
      <button class="back-btn" onclick="RaceManager.backToSubMenu()">Retour</button>
  </div>

  <div id="car-select-screen">
      <h2 class="text-3xl font-black text-white mb-6" style="font-family:Orbitron;">GARAGE DRIFT</h2>
      <div class="mode-container">
          <div class="car-card card-street" onclick="RaceManager.confirmDriftCar('street')">
              <h3>STREET</h3>
              <p>√âQUILIBR√âE</p>
              <div class="stats">
                  <div style="display:flex; justify-content:space-between; font-size:10px;"><span>VITESSE</span><span>80%</span></div>
                  <div class="stat-bar"><div class="stat-fill" style="width:80%;"></div></div>
                  <div style="display:flex; justify-content:space-between; font-size:10px;"><span>DRIFT</span><span>60%</span></div>
                  <div class="stat-bar"><div class="stat-fill" style="width:60%;"></div></div>
                  <div style="display:flex; justify-content:space-between; font-size:10px;"><span>CONTR√îLE</span><span>90%</span></div>
                  <div class="stat-bar"><div class="stat-fill" style="width:90%;"></div></div>
              </div>
          </div>
          <div class="car-card card-pro" onclick="RaceManager.confirmDriftCar('pro')">
              <h3>PRO</h3>
              <p>MONSTRE</p>
              <div class="stats">
                  <div style="display:flex; justify-content:space-between; font-size:10px;"><span>VITESSE</span><span>95%</span></div>
                  <div class="stat-bar"><div class="stat-fill" style="width:95%;"></div></div>
                  <div style="display:flex; justify-content:space-between; font-size:10px;"><span>DRIFT</span><span>100%</span></div>
                  <div class="stat-bar"><div class="stat-fill" style="width:100%;"></div></div>
                  <div style="display:flex; justify-content:space-between; font-size:10px;"><span>CONTR√îLE</span><span>40%</span></div>
                  <div class="stat-bar"><div class="stat-fill" style="width:40%;"></div></div>
              </div>
          </div>
      </div>
      <button class="back-btn" onclick="RaceManager.backToMain()">Retour</button>
  </div>

  <div id="leaderboard-panel">
    <h1 class="text-2xl font-black text-yellow-400 mb-1" style="font-family:Orbitron;">CLASSEMENT <span id="mode-title" class="text-white text-lg ml-2">NORMAL</span></h1>
    <p class="text-xs text-gray-400 mb-3" id="lb-subtitle">BATTEZ LE FANT√îME DU CHAMPION</p>
    <div id="scores-list"><div class="text-center text-gray-400 text-sm py-4">Chargement...</div></div>
    <button id="start-btn" class="action-btn" onclick="RaceManager.startRollingStart()">D√âMARRER</button>
    <div id="name-input-area" style="display:none; margin-top: 14px;">
      <h2 class="text-xl font-black mb-2 text-white">NOUVEAU RECORD !</h2>
      <div class="text-yellow-300 text-2xl font-mono mb-3" id="final-score-display">00:00.00</div>
      <input type="text" id="player-name" placeholder="VOTRE PSEUDO" maxlength="15">
      <button id="submit-score-btn" class="action-btn">ENREGISTRER</button>
    </div>
  </div>

  <div id="mobile-controls" style="display:none;">
    <div class="control-group">
      <div id="btn-left" class="btn">‚¨ÖÔ∏è</div>
      <div id="btn-right" class="btn">‚û°Ô∏è</div>
    </div>
    <div class="control-group">
      <div id="btn-brake" class="btn brake">R</div>
      <div id="btn-gas" class="btn gas">GO</div>
    </div>
  </div>

  <div id="countdown-layer"></div>
  <canvas id="gameCanvas"></canvas>

  <script>
    // --- CONFIG ---
    const DRIFT_CARS_CONFIG = {
        street: { name: "STREET DRIFT", colors: { body1: '#14532d', body2: '#22c55e', body3: '#4ade80', wing: '#052e16' }, physics: { acceleration: 0.21, maxSpeed: 12.3, friction: 0.97, turnSpeed: 0.085, offRoadFriction: 0.6 } },
        pro: { name: "PRO DRIFT", colors: { body1: '#701a75', body2: '#d946ef', body3: '#f0abfc', wing: '#4a044e' }, physics: { acceleration: 0.23, maxSpeed: 12.8, friction: 0.98, turnSpeed: 0.09, offRoadFriction: 0.5 } }
    };
    const MODES = {
        normal: { id: 'normal', type: 'race', name: 'NORMAL', physics: { acceleration: 0.22, maxSpeed: 12.5, friction: 0.965, turnSpeed: 0.075, offRoadFriction: 0.75 }, collection: 'world_tour_records_v3_normal', colors: { body1: '#c53030', body2: '#e53e3e', body3: '#fc8181', wing: '#742a2a' } },
        expert: { id: 'expert', type: 'race', name: 'EXPERT', physics: { acceleration: 0.35, maxSpeed: 22.0, friction: 0.96, turnSpeed: 0.085, offRoadFriction: 0.6 }, collection: 'world_tour_records_v3_expert', colors: { body1: '#111827', body2: '#1f2937', body3: '#374151', wing: '#000000' } },
        drift: { id: 'drift', type: 'drift', name: 'DRIFT KING', physics: DRIFT_CARS_CONFIG.pro.physics, collection: 'world_tour_records_v3_drift', colors: DRIFT_CARS_CONFIG.pro.colors }
    };
    let currentMode = MODES.normal;

    function getCarSpriteUrl(colors) { return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 44 80'%3E%3Cdefs%3E%3ClinearGradient id='bodyGrad' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:${encodeURIComponent(colors.body1)}' /%3E%3Cstop offset='50%25' style='stop-color:${encodeURIComponent(colors.body2)}' /%3E%3Cstop offset='100%25' style='stop-color:${encodeURIComponent(colors.body1)}' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='2' y='2' width='40' height='76' rx='8' fill='rgba(0,0,0,0.3)' /%3E%3Cpath d='M6,10 Q2,20 2,40 Q2,60 6,70 L6,76 Q6,78 8,78 L36,78 Q38,78 38,76 L38,70 Q42,60 42,40 Q42,20 38,10 L36,4 Q36,2 34,2 L10,2 Q8,2 8,4 Z' fill='url(%23bodyGrad)' stroke='${encodeURIComponent(colors.wing)}' stroke-width='1' /%3E%3Cpath d='M8,20 L36,20 L34,32 L10,32 Z' fill='%232d3748' /%3E%3Cpath d='M10,48 L34,48 L36,60 L8,60 Z' fill='%231a202c' /%3E%3Crect x='9' y='33' width='26' height='14' fill='${encodeURIComponent(colors.body2)}' /%3E%3Crect x='4' y='68' width='36' height='8' rx='2' fill='${encodeURIComponent(colors.wing)}' /%3E%3Crect x='6' y='4' width='6' height='4' fill='%23faf089' /%3E%3Crect x='32' y='4' width='6' height='4' fill='%23faf089' /%3E%3C/svg%3E`; }
    const carImage = new Image(); carImage.src = getCarSpriteUrl(currentMode.colors);

    // --- CLOUD ---
    const Cloud = {
      bestScore: -Infinity, unsubscribe: null,
      loadLeaderboard(modeConfig) {
        if(this.unsubscribe) this.unsubscribe();
        this.bestScore = modeConfig.type === 'race' ? Infinity : 0; GhostSystem.setGlobalGhost(null);
        document.getElementById('wr-display').innerText = "--:--.---";
        if (!window.CloudTools) return;
        try {
            const { db, collection, query, orderBy, limit, onSnapshot } = window.CloudTools;
            let sortField = 'timeMs', sortDir = 'asc'; if (modeConfig.type === 'drift') { sortField = 'score'; sortDir = 'desc'; }
            const q = query(collection(db, modeConfig.collection), orderBy(sortField, sortDir), limit(10));
            this.unsubscribe = onSnapshot(q, (snapshot) => {
              const listEl = document.getElementById('scores-list'); listEl.innerHTML = ''; let rank = 1;
              if(snapshot.empty) { listEl.innerHTML = '<div class="text-center text-gray-400 text-sm">Aucun record pour ce mode.</div>'; return; }
              snapshot.forEach(doc => {
                const data = doc.data();
                if (rank === 1) {
                  if (modeConfig.type === 'race') { this.bestScore = data.timeMs; document.getElementById('wr-display').innerText = data.timeStr; } 
                  else { this.bestScore = data.score; document.getElementById('wr-display').innerText = data.score.toLocaleString() + " pts"; }
                  if (data.ghostData) { try { GhostSystem.setGlobalGhost(JSON.parse(data.ghostData)); } catch(e) {} }
                }
                const row = document.createElement('div'); row.className = 'score-row';
                const displayValue = modeConfig.type === 'race' ? data.timeStr : `${data.score} pts`;
                row.innerHTML = `<span>#${rank} ${data.name}</span><span>${displayValue}</span>`;
                listEl.appendChild(row); rank++;
              });
            });
        } catch(e){ console.log("LB Error"); }
      },
      async saveScore(name, value, displayStr, ghostData) {
        if(!window.CloudTools) return false;
        try {
            const { db, collection, addDoc } = window.CloudTools;
            const safeGhost = JSON.stringify(ghostData).length < 950000 ? JSON.stringify(ghostData) : null;
            const payload = { name: name.trim(), ghostData: safeGhost, date: Date.now() };
            if (currentMode.type === 'race') { payload.timeMs = value; payload.timeStr = displayStr; } else { payload.score = value; payload.timeStr = displayStr; }
            await addDoc(collection(db, currentMode.collection), payload); return true; 
        } catch(e) { return false; }
      }
    };

    const GhostSystem = {
      recording: [], bestRecording: [], globalFrames: null, recordCounter: 0,
      resetRecording(){ this.recording = []; this.recordCounter = 0; },
      saveRecordingAsBest(){ this.bestRecording = [...this.recording]; },
      setGlobalGhost(data){ this.globalFrames = data; },
      recordFrame(time, car){
        this.recordCounter++; if (this.recordCounter % 4 !== 0) return;
        this.recording.push({ t: Math.round(time), x: Math.round(car.x), y: Math.round(car.y), a: parseFloat(car.angle.toFixed(2)) });
      },
      drawGlobalGhost(ctx, time){
        if (!this.globalFrames || this.globalFrames.length < 2) return;
        const frames = this.globalFrames;
        let idx = 0; while(idx < frames.length - 1 && frames[idx+1].t < time) idx++;
        const curr = frames[idx], next = frames[idx+1]; if (!next) return;
        const r = Math.max(0, Math.min(1, (time - curr.t) / (next.t - curr.t)));
        const x = curr.x + (next.x - curr.x) * r, y = curr.y + (next.y - curr.y) * r, a = curr.a + (next.a - curr.a) * r;
        ctx.save(); ctx.translate(x, y); ctx.rotate(a + Math.PI/2); ctx.globalAlpha = 0.5;
        if(carImage.complete){ ctx.drawImage(carImage, -22, -40, 44, 80); ctx.globalCompositeOperation = 'source-atop'; ctx.fillStyle = 'rgba(251,191,36,0.6)'; ctx.fillRect(-22, -40, 44, 80); }
        ctx.globalAlpha = 0.8; ctx.globalCompositeOperation = 'source-over'; ctx.fillStyle = "#fbbf24"; ctx.font = "bold 10px Arial"; ctx.textAlign = "center"; ctx.fillText("GHOST", 0, -45); ctx.restore();
      }
    };

    const DriftSystem = {
        totalScore: 0, currentComboScore: 0, multiplier: 1, isDrifting: false, driftTime: 0, wrongWayTimer: 0,
        reset() { this.totalScore = 0; this.currentComboScore = 0; this.multiplier = 1; this.driftTime = 0; this.wrongWayTimer = 0; this.updateUI(); document.getElementById('wrong-way-alert').style.display='none'; },
        update(car, surface) {
            if (currentMode.type !== 'drift') return;
            let nextCP = 0; const cps = RaceManager.checkpoints; for(let i=0; i<cps.length; i++) { if(!cps[i].p) { nextCP = i; break; } }
            const target = (nextCP < cps.length) ? cps[nextCP] : {x:-1200, y:-600};
            const dx = target.x - car.x; const dy = target.y - car.y; const dist = Math.hypot(dx, dy);
            const speed = Math.hypot(car.vx, car.vy);
            
            // Wrong Way
            if (dist > 300 && speed > 2.0) {
                const nx = dx/dist; const ny = dy/dist; const vx = car.vx/speed; const vy = car.vy/speed; const dot = nx*vx + ny*vy;
                if (dot < -0.5) { this.wrongWayTimer++; document.getElementById('wrong-way-alert').style.display = 'block'; if (this.wrongWayTimer > 90) RaceManager.disqualify(); } 
                else { this.wrongWayTimer = 0; document.getElementById('wrong-way-alert').style.display = 'none'; }
            } else { this.wrongWayTimer = 0; document.getElementById('wrong-way-alert').style.display = 'none'; }

            const moveA = Math.atan2(car.vy, car.vx); let slip = Math.abs(moveA - car.angle); while(slip>Math.PI) slip-=Math.PI*2; while(slip<-Math.PI) slip+=Math.PI*2;
            const isSliding = (car.speed > 3.5 && Math.abs(slip) > 0.22);
            const nx = dx/dist; const ny = dy/dist; const vx = car.vx/speed; const vy = car.vy/speed;
            const progressionDot = (dist > 300 && speed > 1) ? (nx*vx + ny*vy) : 1;

            if (surface === 'road' && isSliding) {
                this.isDrifting = true; this.driftTime += 1;
                if (progressionDot > -0.2) { this.currentComboScore += (car.speed * Math.abs(slip) * 2.5); }
                if (this.driftTime > 60 && this.multiplier < 5) { this.multiplier = 2; } if (this.driftTime > 120 && this.multiplier < 10) { this.multiplier = 3; } if (this.driftTime > 240) { this.multiplier = 4; }
                document.getElementById('drift-ui').style.display = 'block';
            } else {
                if (this.currentComboScore > 0) { if (surface === 'road') { if (this.driftTime > 0) this.driftTime -= 2; else this.bankPoints(); } else { this.failCombo("OFF ROAD"); } } 
                else { if(document.getElementById('wrong-way-alert').style.display === 'none') document.getElementById('drift-ui').style.display = 'none'; }
            }
            this.updateUI();
        },
        bankPoints() { this.totalScore += Math.floor(this.currentComboScore * this.multiplier); this.currentComboScore = 0; this.multiplier = 1; this.driftTime = 0; const el = document.getElementById('main-stat-display'); el.classList.remove('pulse'); void el.offsetWidth; el.classList.add('pulse'); },
        failCombo(reason) { if (this.currentComboScore > 100) document.getElementById('drift-current-points').style.color = 'red'; this.currentComboScore = 0; this.multiplier = 1; this.driftTime = 0; },
        updateUI() {
            if (currentMode.type !== 'drift') return;
            document.getElementById('main-stat-display').innerText = Math.floor(this.totalScore).toLocaleString();
            if (this.currentComboScore > 0) { document.getElementById('drift-multiplier').innerText = "x" + this.multiplier; document.getElementById('drift-current-points').innerText = "+" + Math.floor(this.currentComboScore * this.multiplier).toLocaleString(); document.getElementById('drift-current-points').style.color = '#fbbf24'; }
        }
    };

    const VIS = {
        noise: null, seaParticles: [], tires: [], palms: [], palmCache: null, skidsCanvas: null,
        init(ctx){
            this.noise = document.createElement('canvas'); this.noise.width=128; this.noise.height=128;
            const nctx=this.noise.getContext('2d'); const id=nctx.createImageData(128,128);
            for(let i=0;i<id.data.length;i+=4){ const v=(Math.random()*255)|0; id.data[i]=v; id.data[i+1]=v; id.data[i+2]=v; id.data[i+3]=20; } nctx.putImageData(id,0,0);
            this.palmCache = document.createElement('canvas'); this.palmCache.width = 64; this.palmCache.height = 64;
            const pctx = this.palmCache.getContext('2d'); pctx.translate(32, 32);
            pctx.fillStyle = "rgba(0,0,0,0.15)"; pctx.beginPath(); pctx.arc(6, 6, 12, 0, Math.PI * 2); pctx.fill();
            pctx.fillStyle = "#16a34a"; pctx.strokeStyle = "#14532d"; pctx.lineWidth = 1;
            for (let i = 0; i < 7; i++) { pctx.save(); pctx.rotate(i * (Math.PI * 2 / 7)); pctx.beginPath(); pctx.ellipse(0, -14, 4, 16, 0, 0, Math.PI * 2); pctx.fill(); pctx.stroke(); pctx.restore(); }
            pctx.fillStyle = "#5d4037"; pctx.beginPath(); pctx.arc(0, 0, 4, 0, Math.PI * 2); pctx.fill();
            this.skidsCanvas = document.createElement('canvas'); this.skidsCanvas.width = 3000; this.skidsCanvas.height = 3000;
            this.initSea(); this.initTires();
        },
        drawVignette(ctx,w,h){
            const g=ctx.createRadialGradient(w/2,h/2,Math.min(w,h)*0.2,w/2,h/2,Math.min(w,h)*0.7); g.addColorStop(0,'rgba(0,0,0,0)'); g.addColorStop(1,'rgba(0,0,0,0.55)'); ctx.fillStyle=g; ctx.fillRect(0,0,w,h);
        },
        initSea(){ for(let i=0; i<50; i++) this.seaParticles.push({x:Math.random()*3000, y:Math.random()*3000, t:Math.random()*Math.PI*2}); },
        initTires(){ const add=(x,y)=>{for(let i=0;i<3;i++)this.tires.push({x:x+(Math.random()-0.5)*20,y:y+(Math.random()-0.5)*20,c:Math.random()>0.5?'#ef4444':'#ffffff'})}; add(300,-400); add(310,-380); add(300,0); add(-20,400); add(-550,450); },
        initPalms(track){
            this.palms = [];
            for(let i=0; i<60; i++){
                let x, y, safe = false;
                for(let k=0; k<15; k++){ x = 500 + Math.random()*2000; y = 500 + Math.random()*2000; if(track.check(x-1500, y-1500) === 'sand' && track.check(x-1500+25, y-1500) === 'sand' && track.check(x-1500-25, y-1500) === 'sand') { safe = true; break; } }
                if(safe) this.palms.push({x: x-1500, y: y-1500, s: 0.8+Math.random()*0.5});
            }
        },
        drawEnv(ctx){
            ctx.drawImage(this.skidsCanvas, -1500, -1500);
            for(let t of this.tires){ctx.save();ctx.translate(t.x,t.y);ctx.shadowColor="rgba(0,0,0,0.5)";ctx.shadowBlur=5;ctx.fillStyle="#1a1a1a";ctx.beginPath();ctx.arc(0,0,12,0,6.28);ctx.fill();ctx.strokeStyle=t.c;ctx.lineWidth=3;ctx.beginPath();ctx.arc(0,0,6,0,6.28);ctx.stroke();ctx.restore();}
            if (this.palmCache) { for(let p of this.palms){ const size = 64 * p.s; ctx.drawImage(this.palmCache, p.x - size/2, p.y - size/2, size, size); } }
        },
        drawSea(ctx){
            const g=ctx.createRadialGradient(1500,1500,0,1500,1500,2000);g.addColorStop(0,'#06b6d4');g.addColorStop(1,'#0c4a6e');ctx.fillStyle=g;ctx.fillRect(0,0,3000,3000);
            ctx.fillStyle="rgba(255,255,255,0.3)";for(let p of this.seaParticles){p.t+=0.05;ctx.globalAlpha=(Math.sin(p.t)+1)/4;ctx.beginPath();ctx.arc(p.x,p.y,2+Math.sin(p.t),0,6.28);ctx.fill();}ctx.globalAlpha=1;
        },
        addSkid(x1, y1, x2, y2, opacity) {
            const ctx = this.skidsCanvas.getContext('2d'); ctx.save(); ctx.translate(1500, 1500); ctx.lineCap = 'round';
            ctx.strokeStyle = `rgba(0,0,0,${opacity * 0.5})`; ctx.lineWidth = 6; ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke(); ctx.restore();
        }
    };

    const Particles = {
      list: [],
      spawn(x,y, vx,vy, kind){ this.list.push({x,y,vx,vy,r:kind==='smoke'?8+Math.random()*10:5+Math.random()*8,a:kind==='smoke'?0.4:0.25,d:0.01,kind}); },
      update(){ for(let p of this.list){ p.x+=p.vx; p.y+=p.vy; p.r*=1.015; p.a-=p.d; } this.list=this.list.filter(p=>p.a>0); },
      draw(ctx){
        ctx.save();
        for(let p of this.list){
          if (p.kind === 'smoke' && currentMode.type === 'drift' && DriftSystem.multiplier > 2) ctx.fillStyle = `rgba(217, 70, 239, ${p.a})`; 
          else ctx.fillStyle = p.kind==='smoke'?`rgba(255,255,255,${p.a})`:`rgba(190,255,215,${p.a*0.6})`;
          ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,6.28); ctx.fill();
        }
        ctx.restore();
      }
    };

    const TRACK_CONFIG = { roadColor: '#334155', sandColor: '#fcd34d' };
    const Track = {
      collisionCtx: null,
      init(){
        const c=document.createElement('canvas');c.width=3000;c.height=3000;
        this.collisionCtx=c.getContext('2d',{willReadFrequently:true});
        this.drawMask(); VIS.init(c.getContext('2d')); VIS.initPalms(this);
      },
      trace(ctx){
        ctx.beginPath(); ctx.moveTo(-1200,-600); ctx.lineTo(400,-600); ctx.arc(400,-400,200,-1.57,1.57,false); ctx.arc(400,0,200,-1.57,1.57,false);
        ctx.lineTo(-100,200); ctx.arc(-100,400,200,-1.57,3.14,false); ctx.lineTo(-600,400); ctx.arc(-600,-100,500,1.57,-1.57,false); ctx.lineTo(-1200,-600);
      },
      drawMask(){
        const ctx=this.collisionCtx; ctx.clearRect(0,0,3000,3000); ctx.save(); ctx.translate(1500,1500); ctx.lineCap='round';ctx.lineJoin='round';
        ctx.strokeStyle='#FF0000';ctx.lineWidth=450;this.trace(ctx);ctx.stroke(); ctx.strokeStyle='#FFFFFF';ctx.lineWidth=160;this.trace(ctx);ctx.stroke(); ctx.restore();
      },
      draw(ctx){
        ctx.save(); ctx.translate(-1500,-1500); VIS.drawSea(ctx); ctx.restore();
        ctx.lineCap='round';ctx.lineJoin='round'; ctx.shadowColor="rgba(0,0,0,0.2)";ctx.shadowBlur=20;
        ctx.strokeStyle=TRACK_CONFIG.sandColor;ctx.lineWidth=450;this.trace(ctx);ctx.stroke();ctx.shadowBlur=0;
        ctx.strokeStyle=TRACK_CONFIG.roadColor;ctx.lineWidth=160;this.trace(ctx);ctx.stroke();
        ctx.save();ctx.strokeStyle='#fff';ctx.setLineDash([40,40]);ctx.lineWidth=4;ctx.globalAlpha=0.3;this.trace(ctx);ctx.stroke();ctx.restore();
        ctx.save();ctx.translate(0,-600);ctx.fillStyle='#fff';ctx.fillRect(-12,-80,24,160);for(let y=-80;y<80;y+=20)ctx.fillStyle=((y/20)%2===0)?'#000':'#fff',ctx.fillRect(y%40?-12:0,y,12,20);ctx.restore();
        VIS.drawEnv(ctx);
      },
      check(x,y){
        const mx=Math.floor(x+1500),my=Math.floor(y+1500); if(mx<0||mx>=3000||my<0||my>=3000)return 'sea';
        const p=this.collisionCtx.getImageData(mx,my,1,1).data; if(p[3]===0)return 'sea'; if(p[0]>200&&p[1]<50)return 'sand'; return 'road';
      }
    };

    const RaceManager = {
      totalLaps: 3, currentLap: 1, state: 'menu', startTime: 0, lapStartTime: 0, bestLapTime: Infinity, selectedCategory: null,
      checkpoints: [ {x:500,y:-400,p:false}, {x:400,y:100,p:false}, {x:-200,y:400,p:false}, {x:-900,y:0,p:false} ],
      
      goToDriftMenu() { document.getElementById('welcome-screen').style.display = 'none'; document.getElementById('car-select-screen').style.display = 'flex'; },
      goToRaceSubMenu() { document.getElementById('welcome-screen').style.display = 'none'; document.getElementById('race-sub-screen').style.display = 'flex'; },
      backToMain() { document.getElementById('car-select-screen').style.display = 'none'; document.getElementById('race-sub-screen').style.display = 'none'; document.getElementById('welcome-screen').style.display = 'flex'; },
      backToSubMenu() { document.getElementById('difficulty-screen').style.display = 'none'; document.getElementById('race-sub-screen').style.display = 'flex'; },

      confirmDriftCar(carType) {
          currentMode = MODES.drift; currentMode.physics = DRIFT_CARS_CONFIG[carType].physics; currentMode.colors = DRIFT_CARS_CONFIG[carType].colors;
          this.totalLaps = 3; 
          document.getElementById('car-select-screen').style.display = 'none'; this.finalizeModeSelection();
      },
      selectCategory(cat) {
          this.selectedCategory = cat;
          document.getElementById('race-sub-screen').style.display = 'none'; document.getElementById('difficulty-screen').style.display = 'flex';
      },
      selectDifficulty(diff) {
          currentMode = MODES[diff];
          if(this.selectedCategory === 'practice') { this.totalLaps = Infinity; currentMode.name = "ENTRA√éNEMENT (" + diff.toUpperCase() + ")"; }
          else { this.totalLaps = 3; currentMode.name = "CONTRE-LA-MONTRE (" + diff.toUpperCase() + ")"; }
          document.getElementById('difficulty-screen').style.display = 'none'; this.finalizeModeSelection();
      },
      finalizeModeSelection() {
          document.getElementById('leaderboard-panel').style.display = 'block'; document.getElementById('mode-title').innerText = currentMode.name;
          const label = document.getElementById('main-stat-label'); const subtitle = document.getElementById('lb-subtitle');
          if (currentMode.type === 'drift') { label.innerText = "SCORE"; subtitle.innerText = "MAXIMISEZ VOS POINTS DE D√âRAPAGE"; document.getElementById('main-stat-display').innerText = "0"; } 
          else { label.innerText = "CHRONO"; subtitle.innerText = "BATTEZ LE FANT√îME DU CHAMPION"; document.getElementById('main-stat-display').innerText = "00:00.000"; }
          carImage.src = getCarSpriteUrl(currentMode.colors); 
          Cloud.loadLeaderboard(currentMode);
      },
      startRollingStart(){
        this.state = 'rolling'; car.reset(); car.x = -1200; car.y = -600; car.angle = 0; car.speed = currentMode.physics.maxSpeed; car.vx = car.speed;
        this.checkpoints.forEach(cp=>cp.p=false); 
        GhostSystem.resetRecording(); DriftSystem.reset(); 
        document.getElementById('leaderboard-panel').style.display='none'; document.getElementById('pause-menu').style.display='none'; document.getElementById('pause-btn').style.display='none'; document.getElementById('dq-screen').style.display='none';
        document.getElementById('mobile-controls').style.display='flex';
        if (this.totalLaps === Infinity) document.getElementById('lap-display').innerText = "Tours: 0";
        else document.getElementById('lap-display').innerText = `1 / ${this.totalLaps}`;
        if(currentMode.type === 'drift') document.getElementById('main-stat-display').innerText = "0"; else document.getElementById('main-stat-display').innerText = "00:00.000";
        const cd = document.getElementById('countdown-layer'); cd.style.display = 'flex'; cd.innerHTML = '<div class="rolling-text">PR√äT ?</div>';
      },
      beginRacing(){
        this.state='racing'; this.startTime = Date.now(); this.lapStartTime = this.startTime; this.currentLap = 1; this.bestLapTime = Infinity;
        document.getElementById('pause-btn').style.display='flex';
        const cd = document.getElementById('countdown-layer'); cd.innerHTML = '<div class="go-text">GO!</div>'; setTimeout(() => { if(this.state === 'racing') cd.style.display = 'none'; }, 1000);
      },
      disqualify(){
          this.state = 'disqualified';
          document.getElementById('mobile-controls').style.display = 'none';
          document.getElementById('pause-btn').style.display = 'none';
          document.getElementById('drift-ui').style.display = 'none';
          document.getElementById('dq-screen').style.display = 'flex';
      },
      update(car){
        if (this.state === 'rolling') { car.controls = { u: true, d: false, l: false, r: false }; if (car.x >= 0) this.beginRacing(); return; }
        if(this.state!=='racing') return;
        const now = Date.now(); const lapTime = now - this.lapStartTime;
        GhostSystem.recordFrame(lapTime, car);
        this.checkpoints.forEach(cp => { if(!cp.p && Math.hypot(car.x-cp.x, car.y-cp.y) < 300) cp.p = true; });
        if(Math.abs(car.y - (-600)) < 80 && car.x > 0 && car.lastX <= 0 && this.checkpoints.every(cp => cp.p)) this.completeLap(now);
      },
      completeLap(now){
        DriftSystem.bankPoints();
        const lapTime = now - this.lapStartTime;
        if (lapTime < this.bestLapTime) {
            this.bestLapTime = lapTime; GhostSystem.saveRecordingAsBest(); 
            if (this.totalLaps === Infinity) { GhostSystem.setGlobalGhost(GhostSystem.bestRecording); }
        }
        if(this.currentLap >= this.totalLaps) { this.finishRace(now); } else { 
            this.currentLap++; this.lapStartTime = now; 
            if(this.totalLaps === Infinity) document.getElementById('lap-display').innerText = `Tours: ${this.currentLap - 1}`;
            else document.getElementById('lap-display').innerText = `${this.currentLap} / ${this.totalLaps}`;
            this.checkpoints.forEach(cp=>cp.p=false); GhostSystem.resetRecording(); 
        }
      },
      finishRace(now){
        this.state='finished'; let valueToSubmit, strToSubmit;
        if (currentMode.type === 'drift') { valueToSubmit = DriftSystem.totalScore; strToSubmit = valueToSubmit.toLocaleString() + " pts"; } 
        else { valueToSubmit = this.bestLapTime; strToSubmit = this.formatTime(valueToSubmit); }
        document.getElementById('pause-btn').style.display='none'; document.getElementById('leaderboard-panel').style.display='block'; document.getElementById('start-btn').style.display='none'; document.getElementById('mobile-controls').style.display='none'; document.getElementById('drift-ui').style.display='none';
        document.getElementById('name-input-area').style.display='block'; document.getElementById('final-score-display').innerText = strToSubmit;
        const nameInput = document.getElementById('player-name'); const savedName = localStorage.getItem('drift_nc_username'); if(savedName) nameInput.value = savedName;
        const submitBtn = document.getElementById('submit-score-btn'); const newBtn = submitBtn.cloneNode(true); submitBtn.parentNode.replaceChild(newBtn, submitBtn);
        newBtn.onclick = async () => {
          const name = document.getElementById('player-name').value; if(name.length < 1) return;
          localStorage.setItem('drift_nc_username', name); newBtn.innerText = "ENVOI..."; newBtn.disabled = true;
          const saved = await Cloud.saveScore(name, valueToSubmit, strToSubmit, GhostSystem.bestRecording);
          if (saved) { document.getElementById('name-input-area').innerHTML = '<div class="text-emerald-300 font-black py-4">SCORE ENREGISTR√â !</div><button class="action-btn" onclick="location.reload()">REJOUER</button>'; } else { newBtn.innerText = "R√âESSAYER"; newBtn.disabled = false; }
        };
      },
      formatTime(ms){ let m = Math.floor(ms/60000), s = Math.floor((ms%60000)/1000), c = Math.floor((ms%1000)/10); return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${c.toString().padStart(2,'0')}`; },
      pauseGame(){ if(this.state==='racing'){ this.state='paused'; this.pausedTime = Date.now(); document.getElementById('pause-menu').style.display='flex'; document.getElementById('mobile-controls').style.display='none'; } },
      resumeGame(){ if(this.state==='paused'){ const d = Date.now() - this.pausedTime; this.startTime += d; this.lapStartTime += d; this.state='racing'; document.getElementById('pause-menu').style.display='none'; document.getElementById('mobile-controls').style.display='flex'; } },
      quitToMenu(){ location.reload(); }
    };

    class Car{
      constructor(){ this.reset(); this.skids=[]; }
      reset(){ this.x=0; this.y=-600; this.lastX=0; this.angle=0; this.vx=0; this.vy=0; this.speed=0; this.controls={u:false,d:false,l:false,r:false}; }
      update(){
        this.lastX=this.x; if(RaceManager.state!=='racing' && RaceManager.state !== 'rolling') return;
        const phys = currentMode.physics;
        if(Math.abs(this.speed)>0.1){ const dir = this.speed>0?1:-1; if(this.controls.l) this.angle -= phys.turnSpeed*dir; if(this.controls.r) this.angle += phys.turnSpeed*dir; }
        let f=0; if(this.controls.u) f=phys.acceleration; if(this.controls.d) f = -phys.acceleration * 0.6; 
        this.vx += Math.cos(this.angle)*f; this.vy += Math.sin(this.angle)*f;
        const surface = Track.check(this.x, this.y);
        let fric = phys.friction; if(surface === 'sand') fric = phys.offRoadFriction; if(surface === 'sea') fric = 0.5;
        this.speed = Math.hypot(this.vx, this.vy); this.vx *= fric; this.vy *= fric;
        if(this.speed>phys.maxSpeed){ const r = phys.maxSpeed/this.speed; this.vx*=r; this.vy*=r; this.speed = phys.maxSpeed; }
        this.x += this.vx; this.y += this.vy;
        const moveA = Math.atan2(this.vy, this.vx); let slip = Math.abs(moveA - this.angle); while(slip>Math.PI) slip-=Math.PI*2; while(slip<-Math.PI) slip+=Math.PI*2;
        const drifting = (this.speed>4 && Math.abs(slip)>0.30);
        DriftSystem.update(this, surface);
        if(drifting && surface==='road'){
          const c=Math.cos(this.angle), s=Math.sin(this.angle); const rX = this.x - c*20, rY = this.y - s*20;
          const x1=rX+s*11, y1=rY-c*11, x2=rX-s*11, y2=rY+c*11;
          this.skids.push({x:x1, y:y1, a:0.55, w:2.6}); this.skids.push({x:x2, y:y2, a:0.55, w:2.6});
          VIS.addSkid(x1, y1, x1-this.vx*0.5, y1-this.vy*0.5, 0.2); VIS.addSkid(x2, y2, x2-this.vx*0.5, y2-this.vy*0.5, 0.2);
          if(Math.random()<0.55) Particles.spawn(rX, rY, -this.vx*0.15, -this.vy*0.15, 'smoke');
        }
        if(surface==='sand' && this.speed>3 && Math.random()<0.35) Particles.spawn(this.x, this.y, -this.vx*0.05, -this.vy*0.05, 'dust');
        for(const sk of this.skids) sk.a -= 0.08; this.skids = this.skids.filter(sk => sk.a > 0);
      }
      draw(ctx){
        ctx.save(); ctx.lineCap = 'round'; for(const sk of this.skids){ ctx.strokeStyle = `rgba(0,0,0,${sk.a})`; ctx.lineWidth = sk.w; ctx.beginPath(); ctx.moveTo(sk.x, sk.y); ctx.lineTo(sk.x-this.vx*0.25, sk.y-this.vy*0.25); ctx.stroke(); } ctx.restore();
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle+Math.PI/2); ctx.globalAlpha = 0.28; ctx.fillStyle = '#000'; ctx.beginPath(); ctx.ellipse(0, 10, 16, 26, 0, 0, 6.28); ctx.fill(); ctx.globalAlpha = 1; if(carImage.complete) ctx.drawImage(carImage,-22,-40,44,80); ctx.restore();
      }
    }

    const canvas = document.getElementById('gameCanvas'); const ctx = canvas.getContext('2d'); const car = new Car();
    function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize(); Track.init();

    const keys = {ArrowUp:'u',ArrowDown:'d',ArrowLeft:'l',ArrowRight:'r', z:'u',Z:'u',w:'u',W:'u', s:'d',S:'d', q:'l',Q:'l',a:'l',A:'l', d:'r',D:'r'};
    window.onkeydown = e => { if(keys[e.key]) car.controls[keys[e.key]]=true; };
    window.onkeyup   = e => { if(keys[e.key]) car.controls[keys[e.key]]=false; };
    const bindTouch = (id,k) => {
      const el=document.getElementById(id);
      const h = (e) => { e.preventDefault(); car.controls[k]=true; el.classList.add('active'); if(navigator.vibrate) navigator.vibrate(10); };
      const r = (e) => { e.preventDefault(); car.controls[k]=false; el.classList.remove('active'); };
      el.ontouchstart=h; el.ontouchend=r; el.onmousedown=h; el.onmouseup=r; el.onmouseleave=r;
    };
    bindTouch('btn-left','l'); bindTouch('btn-right','r'); bindTouch('btn-gas','u'); bindTouch('btn-brake','d');

    let lastTime = 0, accumulator = 0; const FIXED_STEP = 1000 / 60;
    function loop(t) {
      if (!lastTime) lastTime = t; let dt = t - lastTime; lastTime = t; if (dt > 100) dt = 100; accumulator += dt;
      while (accumulator >= FIXED_STEP) { if (RaceManager.state === 'racing' || RaceManager.state === 'rolling') { car.update(); RaceManager.update(car); } Particles.update(); accumulator -= FIXED_STEP; }
      ctx.clearRect(0,0,canvas.width,canvas.height); ctx.save();
      let camX = canvas.width/2 - car.x - car.vx*10; let camY = canvas.height/2 - car.y - car.vy*10;
      ctx.translate(camX, camY); Track.draw(ctx);
      if(RaceManager.state === 'racing' || RaceManager.state === 'paused'){ const time = (RaceManager.state==='paused'?RaceManager.pausedTime:Date.now()) - RaceManager.lapStartTime; GhostSystem.drawGlobalGhost(ctx, time); if(currentMode.type === 'race') document.getElementById('main-stat-display').innerText = RaceManager.formatTime(time); }
      Particles.draw(ctx); car.draw(ctx); ctx.restore();
      VIS.drawVignette(ctx, canvas.width, canvas.height);
      if(VIS.noise && VIS.noise.width) { ctx.save(); ctx.globalAlpha=0.08; ctx.fillStyle=ctx.createPattern(VIS.noise,'repeat'); ctx.fillRect(0,0,canvas.width,canvas.height); ctx.restore(); }
      requestAnimationFrame(loop);
    }
    requestAnimationFrame(loop);
  </script>
</body>
</html>
