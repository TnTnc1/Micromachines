<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Drift NC</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Firebase Imports & Configuration -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-analytics.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // CONFIGURATION FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyAv5_57JNF_-ZK7lRAOnqnD_C6zbXzHxSE",
            authDomain: "micromachines-8e585.firebaseapp.com",
            projectId: "micromachines-8e585",
            storageBucket: "micromachines-8e585.firebasestorage.app",
            messagingSenderId: "148484924404",
            appId: "1:148484924404:web:7fe9d8c4abac880a574fa1",
            measurementId: "G-78WHHQGK2S"
        };

        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const GAME_COLLECTION_ID = "world_tour_records_v3"; 

        signInAnonymously(auth)
            .then((userCredential) => {
                console.log("Connecté ID:", userCredential.user.uid);
                window.Cloud.init(db, GAME_COLLECTION_ID);
            })
            .catch((error) => {
                console.error("Erreur Auth:", error);
            });

        window.fs = { collection, addDoc, query, orderBy, limit, onSnapshot };
    </script>

    <style>
        body { 
            margin: 0; overflow: hidden; background-color: #1a202c; 
            color: white; font-family: 'Segoe UI', sans-serif;
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        canvas { display: block; }
        
        #hud-layer { 
            position: absolute; top: 0; left: 0; width: 100%;
            padding: 10px; pointer-events: none; z-index: 10; 
            display: flex; justify-content: space-between;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.8);
        }
        .hud-box { text-align: center; }
        .big-time { font-size: 2.5rem; font-weight: bold; font-family: monospace; color: #fbbf24; }
        .label { font-size: 0.8rem; text-transform: uppercase; opacity: 0.8; color: #cbd5e0; }
        .sub-info { font-family: monospace; font-size: 1.2rem; color: white; }

        /* Welcome Screen Styles */
        #welcome-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 70; /* Au-dessus de tout */
        }

        #leaderboard-panel {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: rgba(26, 32, 44, 0.95); padding: 25px; border-radius: 15px;
            border: 1px solid #4a5568; box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            width: 90%; max-width: 450px; z-index: 60; text-align: center;
            display: none; /* Caché au début, affiché après l'écran d'accueil */
        }
        
        .score-row {
            display: flex; justify-content: space-between; padding: 8px 10px;
            border-bottom: 1px solid #2d3748; font-family: monospace; font-size: 1rem;
        }
        .score-row:nth-child(1) { color: #fbbf24; font-weight: bold; }
        .score-row:nth-child(2) { color: #e2e8f0; }
        .score-row:nth-child(3) { color: #b794f4; }

        #name-input-area { display: none; margin-top: 20px; }
        input {
            background: #2d3748; border: 2px solid #4a5568; color: white;
            padding: 10px; border-radius: 5px; width: 80%; text-align: center;
            font-size: 1.1rem; outline: none;
        }
        
        .action-btn {
            background: #4299e1; border: none; padding: 10px 20px;
            color: white; font-weight: bold; border-radius: 20px; cursor: pointer;
            margin-top: 15px; width: 100%; transition: background 0.2s;
        }
        .action-btn:hover { background: #3182ce; }
        .action-btn:disabled { background: #718096; cursor: not-allowed; }

        #mobile-controls {
            position: absolute; bottom: 20px; left: 0; width: 100%; height: 140px;
            display: flex; justify-content: space-between; padding: 0 30px; box-sizing: border-box;
            pointer-events: none; z-index: 20;
        }
        .control-group { display: flex; gap: 20px; align-items: flex-end; pointer-events: auto; }
        .btn {
            width: 80px; height: 80px; background: rgba(255, 255, 255, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; color: white; backdrop-filter: blur(4px); touch-action: none;
        }
        .btn:active, .btn.active { background: rgba(255, 255, 255, 0.4); transform: scale(0.95); }
    </style>
</head>
<body>

    <div id="hud-layer">
        <div class="hud-box" style="text-align: left;">
            <div class="label">Tour</div>
            <div id="lap-display" class="sub-info text-2xl">1 / 3</div>
        </div>
        <div class="hud-box">
            <div class="label">Chrono</div>
            <div id="time-display" class="big-time">00:00.00</div>
        </div>
        <div class="hud-box" style="text-align: right;">
            <div class="label">Record du Monde</div>
            <div id="wr-display" class="sub-info" style="color: #fbbf24;">--:--.--</div>
        </div>
    </div>

    <!-- ÉCRAN D'ACCUEIL DRIFT NC -->
    <div id="welcome-screen">
        <h1 class="text-6xl font-black text-yellow-400 mb-6 italic tracking-tighter drop-shadow-lg" style="text-shadow: 4px 4px 0 #000;">DRIFT NC</h1>
        
        <!-- ZONE IMAGE ACCUEIL -->
        <div class="mb-8 p-2 bg-white rounded-lg shadow-2xl transform -rotate-2 hover:rotate-0 transition duration-500">
            <!-- REMPLACE L'URL CI-DESSOUS PAR TON LIEN POSTIMAGE -->
            <img id="poster-img" src="https://placehold.co/600x350/2d3748/FFF?text=IMAGE+ACCUEIL+DRIFT+NC" alt="Drift NC Poster" class="rounded w-full max-w-md h-auto border border-gray-200">
        </div>

        <button id="enter-btn" class="px-10 py-4 bg-gradient-to-r from-blue-500 to-teal-400 text-white font-bold text-2xl rounded-full shadow-lg hover:scale-105 transition transform border-b-4 border-blue-700">
            JOUER
        </button>
        <p class="mt-4 text-gray-400 text-sm">Le jeu de drift Calédonien</p>
    </div>

    <!-- LEADERBOARD / MENU PRINCIPAL -->
    <div id="leaderboard-panel">
        <h1 class="text-3xl font-bold text-yellow-400 mb-1" style="text-shadow: 2px 2px 0 #000;">CLASSEMENT</h1>
        <p class="text-xs text-gray-400 mb-4">BATTEZ LE FANTÔME DU CHAMPION</p>

        <div id="scores-list" class="mb-4 text-left bg-gray-800 rounded p-2 max-h-48 overflow-y-auto">
            <div class="text-center text-gray-500 text-sm py-4">Chargement...</div>
        </div>

        <button id="start-btn" class="action-btn" style="background: #48bb78; font-size: 1.2rem;">DÉMARRER LA COURSE</button>
        
        <div id="name-input-area">
            <h2 class="text-xl font-bold text-white mb-2">NOUVEAU RECORD !</h2>
            <div class="text-yellow-300 text-2xl font-mono mb-4" id="final-time-display">00:00.00</div>
            <input type="text" id="player-name" placeholder="VOTRE PSEUDO" maxlength="15">
            <button id="submit-score-btn" class="action-btn">ENREGISTRER</button>
        </div>
    </div>

    <div id="mobile-controls" style="display:none;">
        <div class="control-group">
            <div id="btn-left" class="btn">⬅️</div>
            <div id="btn-right" class="btn">➡️</div>
        </div>
        <div class="control-group">
            <div id="btn-brake" class="btn brake">R</div>
            <div id="btn-gas" class="btn gas">GO</div>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const carSpriteSrc = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 44 80'%3E%3Cdefs%3E%3ClinearGradient id='bodyGrad' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' style='stop-color:%23c53030' /%3E%3Cstop offset='50%25' style='stop-color:%23e53e3e' /%3E%3Cstop offset='100%25' style='stop-color:%239b2c2c' /%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='2' y='2' width='40' height='76' rx='8' fill='rgba(0,0,0,0.3)' /%3E%3Cpath d='M6,10 Q2,20 2,40 Q2,60 6,70 L6,76 Q6,78 8,78 L36,78 Q38,78 38,76 L38,70 Q42,60 42,40 Q42,20 38,10 L36,4 Q36,2 34,2 L10,2 Q8,2 8,4 Z' fill='url(%23bodyGrad)' stroke='%23742a2a' stroke-width='1' /%3E%3Cpath d='M8,20 L36,20 L34,32 L10,32 Z' fill='%232d3748' /%3E%3Cpath d='M10,48 L34,48 L36,60 L8,60 Z' fill='%231a202c' /%3E%3Crect x='9' y='33' width='26' height='14' fill='%23e53e3e' /%3E%3Crect x='20' y='2' width='4' height='78' fill='rgba(255,255,255,0.8)' /%3E%3Crect x='4' y='68' width='36' height='8' rx='2' fill='%23742a2a' /%3E%3Crect x='6' y='4' width='6' height='4' fill='%23faf089' /%3E%3Crect x='32' y='4' width='6' height='4' fill='%23faf089' /%3E%3C/svg%3E";
        const carImage = new Image(); carImage.src = carSpriteSrc;

        // ==========================================
        // 1. DATA & CLOUD
        // ==========================================
        window.Cloud = {
            db: null,
            collectionId: null,
            worldRecordTime: Infinity,
            globalGhostData: null,

            init: function(database, collectionId) {
                this.db = database;
                this.collectionId = collectionId;
                this.listenToLeaderboard();
            },

            listenToLeaderboard: function() {
                if(!this.db) return;
                const { collection, query, orderBy, limit, onSnapshot } = window.fs;
                const q = query(
                    collection(this.db, this.collectionId),
                    orderBy('timeMs', 'asc'),
                    limit(10)
                );

                onSnapshot(q, (snapshot) => {
                    const listEl = document.getElementById('scores-list');
                    listEl.innerHTML = '';
                    let rank = 1;
                    
                    if(snapshot.empty) {
                        listEl.innerHTML = '<div class="text-center text-gray-500 text-sm">Aucun record. Soyez le premier !</div>';
                        this.worldRecordTime = Infinity;
                        return;
                    }

                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (rank === 1) {
                            this.worldRecordTime = data.timeMs;
                            document.getElementById('wr-display').innerText = data.timeStr;
                            if (data.ghostData) {
                                try {
                                    this.globalGhostData = JSON.parse(data.ghostData);
                                    GhostSystem.setGlobalGhost(this.globalGhostData);
                                    console.log("Fantôme chargé: " + this.globalGhostData.length + " points");
                                } catch(e) { console.error("Erreur ghost", e); }
                            }
                        }
                        const row = document.createElement('div');
                        row.className = 'score-row';
                        row.innerHTML = `<span>#${rank} ${data.name}</span><span>${data.timeStr}</span>`;
                        listEl.appendChild(row);
                        rank++;
                    });
                }, (error) => console.error("Erreur scores:", error));
            },

            saveScore: async function(name, timeMs, timeStr, ghostData) {
                if(!this.db) { alert("Pas de connexion."); return false; }
                const { collection, addDoc } = window.fs;
                
                const ghostString = JSON.stringify(ghostData);
                console.log("Taille Fantôme (chars):", ghostString.length);
                
                const safeGhost = ghostString.length < 950000 ? ghostString : null; 

                if(!safeGhost) console.warn("Fantôme trop volumineux, ignoré.");

                try {
                    await addDoc(collection(this.db, this.collectionId), {
                        name: name.trim(), 
                        timeMs: timeMs,
                        timeStr: timeStr,
                        ghostData: safeGhost,
                        date: Date.now()
                    });
                    return true;
                } catch(e) {
                    console.error("Erreur sauvegarde:", e);
                    alert("Erreur sauvegarde. Vérifiez connexion.");
                    return false;
                }
            }
        };

        // ==========================================
        // 2. GHOST SYSTEM
        // ==========================================
        const GhostSystem = {
            recording: [],
            bestRecording: [],
            globalFrames: null,
            recordCounter: 0,
            
            resetRecording: function() {
                this.recording = [];
                this.recordCounter = 0;
            },

            saveRecordingAsBest: function() {
                this.bestRecording = [...this.recording];
            },

            setGlobalGhost: function(data) {
                this.globalFrames = data;
            },

            recordFrame: function(time, car) {
                this.recordCounter++;
                if (this.recordCounter % 4 !== 0) return;

                this.recording.push({
                    t: Math.round(time),
                    x: Math.round(car.x),
                    y: Math.round(car.y),
                    a: parseFloat(car.angle.toFixed(2))
                });
            },

            drawGlobalGhost: function(ctx, time) {
                if (!this.globalFrames || this.globalFrames.length < 2) return;
                
                const frames = this.globalFrames;
                
                let idx = 0;
                while(idx < frames.length - 1 && frames[idx+1].t < time) {
                    idx++;
                }
                
                const curr = frames[idx];
                const next = frames[idx+1];
                
                if (!next) return;

                const ratio = (time - curr.t) / (next.t - curr.t);
                const clampedRatio = Math.max(0, Math.min(1, ratio));

                const x = curr.x + (next.x - curr.x) * clampedRatio;
                const y = curr.y + (next.y - curr.y) * clampedRatio;
                const a = curr.a + (next.a - curr.a) * clampedRatio;

                ctx.save();
                ctx.translate(x, y);
                ctx.rotate(a + Math.PI/2); 

                ctx.globalAlpha = 0.5;
                if(carImage.complete) {
                    ctx.drawImage(carImage, -22, -40, 44, 80);
                    ctx.globalCompositeOperation = 'source-atop';
                    ctx.fillStyle = 'rgba(251, 191, 36, 0.6)'; 
                    ctx.fillRect(-22, -40, 44, 80);
                } else {
                    ctx.fillStyle = '#fbbf24';
                    ctx.fillRect(-11, -19, 22, 38);
                }
                
                ctx.globalAlpha = 0.8;
                ctx.globalCompositeOperation = 'source-over';
                ctx.fillStyle = "#fbbf24";
                ctx.font = "bold 10px Arial";
                ctx.textAlign = "center";
                ctx.fillText("CHAMPION", 0, -45);

                ctx.restore();
            }
        };

        // ==========================================
        // 3. GAME ENGINE
        // ==========================================
        const PHYSICS = { acceleration: 0.22, maxSpeed: 12.5, friction: 0.965, turnSpeed: 0.075, offRoadFriction: 0.8 };
        const TRACK_CONFIG = { roadColor: '#4a5568', grassColor: '#276749', lineWidth: 160, borderColor: '#e2e8f0', borderWidth: 6 };

        const Track = {
            collisionCtx: null, mapW: 3000, mapH: 3000,
            init: function() {
                const c = document.createElement('canvas'); c.width = this.mapW; c.height = this.mapH;
                this.collisionCtx = c.getContext('2d', { willReadFrequently: true });
                this.drawMask();
            },
            trace: function(ctx) {
                ctx.beginPath();
                ctx.moveTo(-400, -600); ctx.lineTo(400, -600); 
                ctx.arc(400, -400, 200, -Math.PI/2, Math.PI/2, false);
                ctx.arc(400, 0, 200, -Math.PI/2, Math.PI/2, false);
                ctx.lineTo(-100, 200); ctx.arc(-100, 400, 200, -Math.PI/2, Math.PI, false);
                ctx.lineTo(-600, 400); ctx.arc(-600, -100, 500, Math.PI/2, -Math.PI/2, false);
                ctx.lineTo(-400, -600);
            },
            drawMask: function() {
                const ctx = this.collisionCtx; ctx.save(); ctx.translate(1500, 1500);
                ctx.lineCap = 'round'; ctx.lineJoin = 'round'; ctx.strokeStyle = '#FFF'; ctx.lineWidth = TRACK_CONFIG.lineWidth;
                this.trace(ctx); ctx.stroke(); ctx.restore();
            },
            draw: function(ctx) {
                ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                ctx.strokeStyle = '#e53e3e'; ctx.lineWidth = 172; this.trace(ctx); ctx.stroke();
                ctx.strokeStyle = '#FFF'; ctx.lineWidth = 166; this.trace(ctx); ctx.stroke();
                ctx.strokeStyle = '#4a5568'; ctx.lineWidth = 160; this.trace(ctx); ctx.stroke();
                ctx.save(); ctx.translate(0, -600); ctx.fillStyle='#FFF'; ctx.fillRect(-12,-80,24,160);
                ctx.fillStyle='#000'; for(let y=-80;y<80;y+=20){ 
                    if((y/20)%2==0) ctx.fillRect(-12,y,12,20); else ctx.fillRect(0,y,12,20); 
                } ctx.restore();
            },
            check: function(x,y) {
                const mx = Math.floor(x+1500); const my = Math.floor(y+1500);
                if(mx<0||mx>=3000||my<0||my>=3000) return 'grass';
                return this.collisionCtx.getImageData(mx,my,1,1).data[3]>0 ? 'road':'grass';
            }
        };

        const RaceManager = {
            totalLaps: 3, currentLap: 1, state: 'menu', 
            startTime: 0, lapStartTime: 0, bestLapTime: Infinity,
            checkpoints: [ {x:500,y:-400,p:false}, {x:400,y:100,p:false}, {x:-200,y:400,p:false}, {x:-900,y:0,p:false} ],

            startRace: function() {
                this.state = 'racing';
                this.startTime = Date.now();
                this.lapStartTime = this.startTime;
                this.currentLap = 1;
                this.bestLapTime = Infinity;
                this.checkpoints.forEach(cp => cp.p = false);
                GhostSystem.resetRecording();
                
                document.getElementById('leaderboard-panel').style.display = 'none';
                document.getElementById('mobile-controls').style.display = 'flex';
                document.getElementById('lap-display').innerText = `1 / ${this.totalLaps}`;
            },

            update: function(car) {
                if(this.state !== 'racing') return;
                
                const now = Date.now();
                const lapTime = now - this.lapStartTime;
                GhostSystem.recordFrame(lapTime, car);

                this.checkpoints.forEach(cp => {
                    if(!cp.p && Math.sqrt((car.x-cp.x)**2 + (car.y-cp.y)**2) < 300) cp.p = true;
                });

                if(Math.abs(car.y - (-600)) < 80 && car.x > 0 && car.lastX <= 0) {
                    if(this.checkpoints.every(cp => cp.p)) {
                        this.completeLap(now);
                    }
                }
            },

            completeLap: function(now) {
                const lapTime = now - this.lapStartTime;
                
                if(lapTime < this.bestLapTime) {
                    this.bestLapTime = lapTime;
                    GhostSystem.saveRecordingAsBest(); 
                }
                
                if(this.currentLap >= this.totalLaps) {
                    this.finishRace(now);
                } else {
                    this.currentLap++;
                    this.lapStartTime = now;
                    document.getElementById('lap-display').innerText = `${this.currentLap} / ${this.totalLaps}`;
                    this.checkpoints.forEach(cp => cp.p = false);
                    GhostSystem.resetRecording(); 
                }
            },

            finishRace: function(now) {
                this.state = 'finished';
                const timeToSubmit = this.bestLapTime;
                const timeStr = this.formatTime(timeToSubmit);

                document.getElementById('leaderboard-panel').style.display = 'block';
                document.getElementById('start-btn').style.display = 'none'; 
                document.getElementById('mobile-controls').style.display = 'none';
                
                document.getElementById('name-input-area').style.display = 'block';
                document.getElementById('final-time-display').innerText = timeStr;

                const submitBtn = document.getElementById('submit-score-btn');
                const newBtn = submitBtn.cloneNode(true);
                submitBtn.parentNode.replaceChild(newBtn, submitBtn);
                
                newBtn.onclick = async () => {
                    const name = document.getElementById('player-name').value;
                    if(name.length < 1) return;
                    
                    newBtn.innerText = "ENVOI...";
                    newBtn.disabled = true;

                    const saved = await window.Cloud.saveScore(name, timeToSubmit, timeStr, GhostSystem.bestRecording);
                    
                    if (saved) {
                        document.getElementById('name-input-area').innerHTML = '<div class="text-green-400 font-bold py-4">SCORE ENREGISTRÉ !</div><button class="action-btn" onclick="location.reload()">REJOUER</button>';
                    } else {
                        newBtn.innerText = "RÉESSAYER";
                        newBtn.disabled = false;
                    }
                };
            },
            
            formatTime: function(ms) {
                let m = Math.floor(ms/60000); let s = Math.floor((ms%60000)/1000); let c = Math.floor((ms%1000)/10);
                return `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}.${c.toString().padStart(2,'0')}`;
            }
        };

        // ==========================================
        // 4. CAR PHYSICS
        // ==========================================
        class Car {
            constructor() { 
                this.x=0; this.y=-600; this.lastX=0; this.angle=0; 
                this.vx=0; this.vy=0; this.speed=0;
                this.controls={u:false,d:false,l:false,r:false};
                this.skids=[];
            }
            update() {
                this.lastX=this.x;
                if(RaceManager.state === 'menu') return;

                if(Math.abs(this.speed)>0.1) {
                    let dir = this.speed>0?1:-1;
                    if(this.controls.l) this.angle -= PHYSICS.turnSpeed*dir;
                    if(this.controls.r) this.angle += PHYSICS.turnSpeed*dir;
                }
                let f=0;
                if(this.controls.u) f=PHYSICS.acceleration;
                if(this.controls.d) f=-PHYSICS.acceleration*0.6;
                
                this.vx += Math.cos(this.angle)*f;
                this.vy += Math.sin(this.angle)*f;
                
                let surface = Track.check(this.x, this.y);
                let fric = surface==='road' ? PHYSICS.friction : PHYSICS.offRoadFriction;
                
                this.speed = Math.sqrt(this.vx**2 + this.vy**2);
                this.vx *= fric; this.vy *= fric;
                
                if(this.speed>PHYSICS.maxSpeed) {
                    let r = PHYSICS.maxSpeed/this.speed; this.vx*=r; this.vy*=r;
                }
                
                this.x+=this.vx; this.y+=this.vy;

                // Skidmarks
                let moveA = Math.atan2(this.vy, this.vx);
                let slip = Math.abs(moveA-this.angle);
                while(slip>Math.PI) slip-=Math.PI*2; while(slip<-Math.PI) slip+=Math.PI*2;
                if(this.speed>4 && Math.abs(slip)>0.35 && surface==='road') {
                    let c=Math.cos(this.angle), s=Math.sin(this.angle);
                    this.skids.push({x:this.x-c*20+s*10, y:this.y-s*20-c*10, l:0.5});
                    this.skids.push({x:this.x-c*20-s*10, y:this.y-s*20+c*10, l:0.5});
                }
            }
            draw(ctx) {
                // Skids
                ctx.save();
                for(let s of this.skids) {
                    ctx.fillStyle=`rgba(26,32,44,${s.l})`; ctx.fillRect(s.x,s.y,4,4); s.l-=0.02;
                }
                this.skids=this.skids.filter(s=>s.l>0);
                ctx.restore();

                // Car
                ctx.save(); ctx.translate(this.x,this.y); ctx.rotate(this.angle+Math.PI/2);
                if(carImage.complete) ctx.drawImage(carImage,-22,-40,44,80);
                else { ctx.fillStyle='#e53e3e'; ctx.fillRect(-11,-19,22,38); }
                ctx.restore();
            }
        }

        // ==========================================
        // 5. MAIN LOOP
        // ==========================================
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const car = new Car();

        function resize() { canvas.width=window.innerWidth; canvas.height=window.innerHeight; }
        window.addEventListener('resize', resize); resize();
        
        Track.init();

        const keys = {ArrowUp:'u',ArrowDown:'d',ArrowLeft:'l',ArrowRight:'r'};
        window.onkeydown = e => { if(keys[e.key]) car.controls[keys[e.key]]=true; }
        window.onkeyup = e => { if(keys[e.key]) car.controls[keys[e.key]]=false; }
        
        const bindTouch = (id,k) => {
            const el=document.getElementById(id);
            el.ontouchstart=e=>{e.preventDefault();car.controls[k]=true;el.classList.add('active')};
            el.ontouchend=e=>{e.preventDefault();car.controls[k]=false;el.classList.remove('active')};
        };
        bindTouch('btn-left','l'); bindTouch('btn-right','r'); bindTouch('btn-gas','u'); bindTouch('btn-brake','d');

        // GESTION DU BOUTON ENTRER (ACCUEIL)
        document.getElementById('enter-btn').onclick = () => {
            document.getElementById('welcome-screen').style.display = 'none';
            document.getElementById('leaderboard-panel').style.display = 'block';
        };

        // START RACE
        document.getElementById('start-btn').onclick = () => RaceManager.startRace();

        function loop() {
            car.update();
            RaceManager.update(car);
            
            ctx.fillStyle = TRACK_CONFIG.grassColor; ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.save();
            let camX = canvas.width/2 - car.x;
            let camY = canvas.height/2 - car.y;
            camX -= car.vx * 10;
            camY -= car.vy * 10;
            ctx.translate(camX, camY);

            Track.draw(ctx);
            
            if(RaceManager.state === 'racing') {
                const time = Date.now() - RaceManager.lapStartTime;
                GhostSystem.drawGlobalGhost(ctx, time);
                document.getElementById('time-display').innerText = RaceManager.formatTime(time);
            }
            
            car.draw(ctx);
            ctx.restore();

            requestAnimationFrame(loop);
        }
        loop();

    </script>
</body>
</html>
